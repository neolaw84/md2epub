name: Release and Publish

on:
  pull_request:
    branches: [ "main" ]
    types: [ closed ]

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # Required for Trusted Publishing

    # Use a dedicated environment for PyPI publishing (safer)
    environment:
      name: pypi
      url: https://pypi.org/p/md2epub

    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build toml
        pip install .[dev]

    - name: Determine Bump Type
      id: bump_type
      run: |
        labels="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
        if [[ "$labels" == *"bump:major"* ]]; then
          echo "type=major" >> $GITHUB_OUTPUT
        elif [[ "$labels" == *"bump:patch"* ]]; then
          echo "type=patch" >> $GITHUB_OUTPUT
        else
          echo "type=minor" >> $GITHUB_OUTPUT
        fi

    - name: Bump Version
      id: bump
      run: |
        new_ver=$(python scripts/bump_version.py ${{ steps.bump_type.outputs.type }})
        echo "new_version=$new_ver" >> $GITHUB_OUTPUT
        
    - name: Commit and Push Version Bump
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add pyproject.toml
        git commit -m "Bump version to ${{ steps.bump.outputs.new_version }}"
        git push origin main

    - name: Build Distribution
      run: python -m build

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.bump.outputs.new_version }}
        name: Release v${{ steps.bump.outputs.new_version }}
        files: dist/*
        generate_release_notes: true

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        # password is NOT required for Trusted Publishing
        packages_dir: dist/
